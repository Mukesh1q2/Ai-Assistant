// Prisma Schema for Clawd Bot
// PostgreSQL database for production

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  password  String
  name      String
  avatar    String?
  role      String   @default("owner")
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Preferences
  theme         String  @default("system")
  notifications Boolean @default(true)
  language      String  @default("en")
  timezone      String  @default("UTC")

  // Plan
  planTier         String @default("free") @map("plan_tier")
  executionQuota   Int    @default(1000) @map("execution_quota")
  usedExecutions   Int    @default(0) @map("used_executions")
  channelLimit     Int    @default(3) @map("channel_limit")
  packLimit        Int    @default(5) @map("pack_limit")
  familySeats      Int    @default(1) @map("family_seats")

  // Encrypted API Keys (stored as encrypted strings)
  openaiApiKey    String? @map("openai_api_key")
  geminiApiKey    String? @map("gemini_api_key")
  anthropicApiKey String? @map("anthropic_api_key")

  // Relations
  bots                Bot[]
  channels            Channel[]
  platformIntegrations PlatformIntegration[]
  executions          Execution[]

  @@map("users")
}

model Bot {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String   @default("")
  avatar      String   @default("/bots/default.png")
  status      String   @default("inactive")
  type        String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Config
  personality   String @default("friendly and helpful")
  memoryScope   String @default("user") @map("memory_scope")
  systemPrompt  String? @map("system_prompt")
  modelProvider String  @default("openai") @map("model_provider")
  modelName     String  @default("gpt-4o") @map("model_name")
  temperature   Float   @default(0.7)

  // Metrics
  totalExecutions      Int @default(0) @map("total_executions")
  successfulExecutions Int @default(0) @map("successful_executions")
  failedExecutions     Int @default(0) @map("failed_executions")
  uptime               Int @default(100)
  lastActiveAt         DateTime? @map("last_active_at")

  // Relations
  userId     String      @map("user_id") @db.Uuid
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  botChannels BotChannel[]
  executions Execution[]
  taskPacks  Json        @default("[]") @map("task_packs")

  @@map("bots")
}

model Channel {
  id          String    @id @default(uuid()) @db.Uuid
  type        String
  name        String
  status      String    @default("disconnected")
  token       String?
  webhook     String?
  guildId     String?   @map("guild_id")
  channelId   String?   @map("channel_id")
  phoneNumber String?   @map("phone_number")
  connectedAt DateTime? @map("connected_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  botChannels BotChannel[]

  @@map("channels")
}

model BotChannel {
  id        String  @id @default(uuid()) @db.Uuid
  botId     String  @map("bot_id") @db.Uuid
  channelId String  @map("channel_id") @db.Uuid
  bot       Bot     @relation(fields: [botId], references: [id], onDelete: Cascade)
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([botId, channelId])
  @@map("bot_channels")
}

model PlatformIntegration {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  platform  String
  name      String
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Telegram fields
  botToken             String? @map("bot_token")
  webhookUrl           String? @map("webhook_url")
  webhookSecret        String? @map("webhook_secret")
  telegramBotId        String? @map("telegram_bot_id")
  telegramBotUsername   String? @map("telegram_bot_username")

  // WhatsApp fields
  whatsappPhoneNumberId      String? @map("whatsapp_phone_number_id")
  whatsappAccessToken        String? @map("whatsapp_access_token")
  whatsappBusinessAccountId  String? @map("whatsapp_business_account_id")
  whatsappVerifyToken        String? @map("whatsapp_verify_token")
  whatsappDisplayNumber      String? @map("whatsapp_display_number")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@map("platform_integrations")
}

model Message {
  id               String   @id @default(uuid()) @db.Uuid
  integrationId    String   @map("integration_id") @db.Uuid
  platform         String
  direction        String   // 'incoming' | 'outgoing'
  chatId           String   @map("chat_id")
  userIdExternal   String?  @map("user_id_external")
  userName         String?  @map("user_name")
  messageText      String?  @map("message_text")
  platformMessageId String? @map("platform_message_id")
  status           String   @default("received")
  createdAt        DateTime @default(now()) @map("created_at")

  integration PlatformIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Execution {
  id            String   @id @default(uuid()) @db.Uuid
  botId         String   @map("bot_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  integrationId String?  @map("integration_id") @db.Uuid
  status        String   @default("pending")
  errorMessage  String?  @map("error_message")
  durationMs    Int?     @map("duration_ms")
  cost          Float    @default(0)
  createdAt     DateTime @default(now()) @map("created_at")

  bot  Bot  @relation(fields: [botId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("executions")
}
